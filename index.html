<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ahmed ‚áÑ Xeo ‚Äî Private Chat</title>
  <link rel="stylesheet" href="./styles.css" />
  <meta name="color-scheme" content="light dark" />
</head>
<body>
  <div id="app">
    <header class="topbar">
      <div class="brand">üïäÔ∏è Ahmed ‚áÑ Xeo</div>
      <button id="signOutBtn" class="ghost" hidden>Sign out</button>
    </header>

    <main class="shell">
      <!-- Sign‚Äëin panel -->
      <section id="authPanel" class="panel">
        <h1>Sign in</h1>
        <p class="muted">Only two accounts are allowed. Use your email &amp; password.</p>
        <form id="authForm" autocomplete="on">
          <label>Email
            <input type="email" id="email" required placeholder="you@example.com" />
          </label>
          <label>Password
            <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </label>
          <label>Display name
            <input type="text" id="displayName" required placeholder="Ahmed or Xeo" />
          </label>
          <label>Room passphrase <small class="muted">(for encryption)</small>
            <input type="password" id="passphrase" required placeholder="shared secret" />
          </label>
          <button type="submit" class="primary">Sign in</button>
        </form>
      </section>

      <!-- Chat panel -->
      <section id="chatPanel" class="panel" hidden>
        <div class="roomHead">
          <div>
            <div class="roomTitle">Private Room</div>
            <div class="roomSub" id="whoami"></div>
          </div>
          <button id="copyInvite" class="ghost">Copy invite link</button>
        </div>
        <div id="messages" class="messages" aria-live="polite"></div>
        <form id="composer" class="composer" autocomplete="off">
          <input id="messageInput" type="text" required maxlength="2000" placeholder="Type a message‚Ä¶" />
          <button id="sendBtn" class="primary" type="submit">Send</button>
        </form>
      </section>
    </main>

    <footer class="foot">
      <small class="muted">E2EE via Web Crypto ‚Ä¢ Firestore sync ‚Ä¢ Static GitHub Pages</small>
    </footer>
  </div>

  <!-- App logic (Firebase & crypto) -->
  <script type="module">
    // Diagnostic logs to confirm the script runs
    console.log("BOOT: module loaded");
    window.addEventListener("DOMContentLoaded", () => console.log("BOOT: DOM ready"));

    // Import Firebase SDK modules from the CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updateProfile }
      from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Import your local modules.  These files must live alongside index.html.
    import cfg from "./firebase-config.js";
    import { deriveKeyFromPassphrase, encryptText, decryptText, bufToBase64, base64ToBuf } from "./app.js";

    // Initialize Firebase with your config
    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db = getFirestore(app);
    console.log("BOOT: Firebase initialized", cfg.projectId);

    // Short helper for document.getElementById
    const $ = (id) => document.getElementById(id);

    const authPanel = $("authPanel");
    const chatPanel = $("chatPanel");
    const messagesEl = $("messages");
    const msgInput = $("messageInput");
    const composer = $("composer");
    const whoami = $("whoami");
    const copyInvite = $("copyInvite");
    const signOutBtn = $("signOutBtn");

    // Derive room ID from the URL (default to ahmed-xeo)
    const roomId = new URL(location.href).searchParams.get("room") || "ahmed-xeo";
    let cryptoKey = null;

    // Copy the invite link with the current room
    copyInvite.addEventListener("click", async () => {
      const url = new URL(location.href);
      url.searchParams.set("room", roomId);
      await navigator.clipboard.writeText(url.toString());
      copyInvite.textContent = "Copied";
      setTimeout(() => (copyInvite.textContent = "Copy invite link"), 1200);
    });

    // Handle sign in
    $("authForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      console.log("HANDLER: submit fired");
      const email = $("email").value.trim();
      const password = $("password").value;
      const displayName = $("displayName").value.trim();
      const passphrase = $("passphrase").value;
      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        if (!cred.user.displayName && displayName) {
          await updateProfile(cred.user, { displayName });
        }
        cryptoKey = await deriveKeyFromPassphrase(passphrase, roomId);
      } catch (err) {
        console.error("AUTH ERROR:", err);
        alert("Sign-in failed: " + (err.code || err.message));
      }
    });

    // Sign out
    signOutBtn.addEventListener("click", () => signOut(auth));

    // Render a message bubble
    function renderMessage(doc, uid) {
      const data = doc.data();
      const row = document.createElement("div");
      row.className = "bubbleRow" + (data.senderUid === uid ? " me" : "");
      const meta = document.createElement("div");
      meta.className = "meta";
      const when = data.createdAt?.toDate?.() || new Date();
      meta.textContent = `${data.senderName || "Unknown"} ‚Ä¢ ${when.toLocaleString()}`;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      const body = document.createElement("div");
      body.className = "body";
      (async () => {
        try {
          const text = cryptoKey
            ? await decryptText(cryptoKey, base64ToBuf(data.iv), base64ToBuf(data.ciphertext))
            : "üîí Encrypted ‚Äî enter passphrase to view";
          body.textContent = text;
        } catch {
          body.textContent = "üîí Decryption failed (wrong passphrase?)";
        }
      })();
      bubble.appendChild(body);
      row.append(meta, bubble);
      return row;
    }

    // Listen for auth state changes to toggle panels and load messages
    onAuthStateChanged(auth, (user) => {
      console.log("AUTH state:", !!user);
      if (user) {
        authPanel.hidden = true;
        chatPanel.hidden = false;
        signOutBtn.hidden = false;
        whoami.textContent = `Signed in as: ${user.displayName || user.email}`;
        const q = query(collection(db, "rooms", roomId, "messages"), orderBy("createdAt"));
        onSnapshot(q, (snap) => {
          messagesEl.innerHTML = "";
          snap.forEach((doc) => messagesEl.appendChild(renderMessage(doc, user.uid)));
          messagesEl.scrollTop = messagesEl.scrollHeight;
        });
      } else {
        authPanel.hidden = false;
        chatPanel.hidden = true;
        signOutBtn.hidden = true;
        whoami.textContent = "";
      }
    });

    // Handle sending a message
    composer.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = msgInput.value.trim();
      if (!text) return;
      if (!cryptoKey) return alert("Enter the room passphrase first.");
      const user = auth.currentUser;
      if (!user) return alert("Not signed in");
      try {
        const { iv, ciphertext } = await encryptText(cryptoKey, text);
        await addDoc(collection(db, "rooms", roomId, "messages"), {
          senderUid: user.uid,
          senderName: user.displayName || user.email,
          iv: bufToBase64(iv),
          ciphertext: bufToBase64(ciphertext),
          createdAt: serverTimestamp(),
        });
        msgInput.value = "";
      } catch (err) {
        console.error("SEND ERROR:", err);
        alert("Send failed: " + (err.code || err.message));
      }
    });
  </script>
</body>
</html>
